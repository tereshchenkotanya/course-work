(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();function Bt(e,t,n,s,i){const a=e.canvas.width,r=e.canvas.height,y=e.getImageData(0,0,a,r),v=t.getImageData(0,0,a,r),m=n.createImageData(a,r);n.canvas.width!==a&&(n.canvas.width=a),n.canvas.height!==r&&(n.canvas.height=r);const g=y.data,f=v.data,d=m.data;let h=0,E=0;for(let o=0;o<g.length;o+=4){const Y=g[o],V=g[o+1],q=g[o+2],G=f[o],K=f[o+1],J=f[o+2],C=Math.abs(Y-G),M=Math.abs(V-K),D=Math.abs(q-J),R=(C+M+D)/3;E+=R*R;const Q=C>i||M>i||D>i;switch(Q&&h++,s){case"highlight":Q?(d[o]=239,d[o+1]=68,d[o+2]=68,d[o+3]=255):(d[o]=Math.round(g[o]*.6),d[o+1]=Math.round(g[o+1]*.6),d[o+2]=Math.round(g[o+2]*.6),d[o+3]=255);break;case"heatmap":{const Z=Math.min(255,Math.max(0,Math.floor(R)));d[o]=Z,d[o+1]=Math.min(80,Math.floor(Z*.3)),d[o+2]=255-Z,d[o+3]=255;break}case"diffRGB":d[o]=C,d[o+1]=M,d[o+2]=D,d[o+3]=255;break}}n.putImageData(m,0,0);const p=a*r,U=p?h/p*100:0,b=p?E/p:0,$=b===0?1/0:20*Math.log10(255)-10*Math.log10(b);return{imageData:m,metrics:{width:a,height:r,diffPixelsCount:h,totalPixels:p,diffPixelsPct:U,mse:b,psnr:$}}}async function it(e){const t=URL.createObjectURL(e),n=new Image;return await new Promise((s,i)=>{n.onload=()=>s(),n.onerror=i,n.src=t}),URL.revokeObjectURL(t),n}function at(e,t,n,s){const i=n??t.naturalWidth,a=s??t.naturalHeight;e.canvas.width=i,e.canvas.height=a,e.clearRect(0,0,i,a),e.drawImage(t,0,0,i,a)}const dt=document.getElementById("fileA"),rt=document.getElementById("fileB"),P=document.getElementById("tolerance"),ht=document.getElementById("tolVal"),Et=document.getElementById("mode"),_=document.getElementById("btnCompare"),mt=document.getElementById("btnDownload"),bt=document.getElementById("canvasA"),Ct=document.getElementById("canvasB"),c=document.getElementById("canvasDiff"),N=bt.getContext("2d"),O=Ct.getContext("2d"),w=c.getContext("2d"),st=document.getElementById("overlay"),ot=document.getElementById("imgA"),k=document.getElementById("imgB"),ct=document.getElementById("slider"),W=document.getElementById("btnBlink"),Mt=document.getElementById("mDims"),Dt=document.getElementById("mPct"),Rt=document.getElementById("mMSE"),Lt=document.getElementById("mPSNR"),St=document.getElementById("mDiffCount"),F=document.getElementById("enableRegionSelect"),et=document.getElementById("btnClearRegion"),l=document.getElementById("canvasSelection"),I=l.getContext("2d"),gt=document.getElementById("regionMetrics"),ut=document.getElementById("rmDims"),yt=document.getElementById("rmPct"),ft=document.getElementById("rmMSE"),pt=document.getElementById("rmPSNR"),vt=document.getElementById("rmDiffCount");let x=null,B=null,z=null,u=null,A=!1,H={x:0,y:0},L=null,tt=null,S=16,lt="highlight";ht.textContent=P.value;P.addEventListener("input",()=>{ht.textContent=P.value,S=parseInt(P.value,10),u&&u.w>0&&u.h>0&&It(u)});function T(e,t,n,s){const i=t.naturalWidth/t.naturalHeight,a=n/s;let r,y,v=0,m=0;i>a?(r=n,y=n/i,m=(s-y)/2):(y=s,r=s*i,v=(n-r)/2),e.canvas.width=n,e.canvas.height=s,e.clearRect(0,0,n,s),e.fillStyle="#0b1227",e.fillRect(0,0,n,s),e.drawImage(t,v,m,r,y)}async function wt(){var n,s;const e=(n=dt.files)==null?void 0:n[0],t=(s=rt.files)==null?void 0:s[0];if(!e||!t){_.disabled=!0,W.disabled=!0,st.setAttribute("data-state","empty"),ot.removeAttribute("src"),k.removeAttribute("src");return}try{x=await it(e),B=await it(t);const i=360,a=480;T(N,x,i,a),T(O,B,i,a),nt(),ot.src=URL.createObjectURL(e),k.src=URL.createObjectURL(t),st.setAttribute("data-state","ready"),_.disabled=!1,W.disabled=!1}catch(i){alert("Помилка завантаження зображення: "+i)}}dt.addEventListener("change",wt);rt.addEventListener("change",wt);_.addEventListener("click",async()=>{if(!x||!B)return;const e=x.naturalWidth===B.naturalWidth&&x.naturalHeight===B.naturalHeight;let t=x.naturalWidth,n=x.naturalHeight,s=B;if(!e){const h=document.createElement("canvas");h.width=t,h.height=n,h.getContext("2d").drawImage(B,0,0,t,n);const p=new Image;p.src=h.toDataURL(),await p.decode(),s=p}at(N,x,t,n),at(O,s,t,n),setTimeout(()=>{nt(),j()},100),w.canvas.width=t,w.canvas.height=n,l.width=t,l.height=n,c.style.display="block",c.style.width="100%",c.style.maxHeight="480px",c.style.position="relative",c.style.zIndex="1",c.style.pointerEvents="auto",l.style.background="transparent",l.style.pointerEvents="none",l.style.zIndex="2",l.style.opacity="0",l.style.visibility="hidden",I.clearRect(0,0,l.width,l.height),j(),S=parseInt(P.value,10),lt=Et.value;const i=Bt(N,O,w,lt,S),r=w.getImageData(0,0,Math.min(10,t),Math.min(10,n)).data.some((h,E)=>E%4!==3&&h!==0);console.log("Canvas diff check:",{internal:{width:w.canvas.width,height:w.canvas.height},display:{width:c.style.width,height:c.style.height},computed:{width:window.getComputedStyle(c).width,height:window.getComputedStyle(c).height},hasData:r,zIndex:window.getComputedStyle(c).zIndex}),(w.canvas.width===0||w.canvas.height===0)&&console.error("Canvas dimensions are zero!",{W:t,H:n,canvasWidth:w.canvas.width,canvasHeight:w.canvas.height}),c.style.visibility="visible",c.style.opacity="1";const y=document.createElement("canvas");y.width=t,y.height=n;const v=y.getContext("2d");v.drawImage(x,0,0);const m=document.createElement("canvas");m.width=t,m.height=n;const g=m.getContext("2d");g.drawImage(s,0,0),L=v.getImageData(0,0,t,n),tt=g.getImageData(0,0,t,n),Mt.textContent=`${i.metrics.width} × ${i.metrics.height}`,Dt.textContent=`${i.metrics.diffPixelsPct.toFixed(2)}%`,Rt.textContent=i.metrics.mse.toFixed(2),Lt.textContent=Number.isFinite(i.metrics.psnr)?i.metrics.psnr.toFixed(2):"∞",St.textContent=`${i.metrics.diffPixelsCount.toLocaleString()} px`,mt.disabled=!1;const f=360,d=480;T(N,x,f,d),T(O,B,f,d),X()});mt.addEventListener("click",()=>{const e=c.toDataURL("image/png"),t=document.createElement("a");t.href=e,t.download="diff.png",t.click()});ct.addEventListener("input",()=>{const e=parseInt(ct.value,10);k.style.clipPath=`inset(0 ${100-e}% 0 0)`});W.addEventListener("click",()=>{if(z!==null){window.clearInterval(z),z=null,W.textContent="Миготіти A/B",k.style.opacity="1";return}W.textContent="Зупинити миготіння";let e=!0;z=window.setInterval(()=>{e=!e,k.style.opacity=e?"1":"0"},500)});function nt(){const e=document.getElementById("canvasA"),t=document.getElementById("canvasB"),n=document.getElementById("overlay"),s=document.getElementById("imgA"),i=document.getElementById("imgB"),a=document.getElementById("canvasDiff");if(e&&e.width>0&&e.height>0&&x&&(e.style.width="360px",e.style.height="480px",e.style.maxWidth="360px",e.style.maxHeight="480px",t&&t.width>0&&t.height>0&&(t.style.width="360px",t.style.height="480px",t.style.maxWidth="360px",t.style.maxHeight="480px"),n&&s.complete&&i.complete&&(n.style.width="360px",n.style.height="480px",n.style.maxWidth="360px",n.style.maxHeight="480px"),a&&a.width>0&&a.height>0)){const v=a.width,m=a.height,g=v/m,f=480;let d=Math.min(m,f),h=d*g;a.style.width=`${h}px`,a.style.height=`${d}px`,a.style.maxHeight=`${f}px`}}function j(){c.getBoundingClientRect();const e=c.parentElement;e.getBoundingClientRect();const t=window.getComputedStyle(e),n=parseInt(t.paddingTop)||12,s=parseInt(t.paddingLeft)||12,i=window.getComputedStyle(c);l.style.width=i.width,l.style.height=i.height,l.style.maxHeight=i.maxHeight||"480px",l.style.top=`${n}px`,l.style.left=`${s}px`}function xt(e){const t=c.getBoundingClientRect(),n=c.width/t.width,s=c.height/t.height;return{x:Math.round((e.clientX-t.left)*n),y:Math.round((e.clientY-t.top)*s)}}function At(e,t,n,s){I.clearRect(0,0,l.width,l.height),n>0&&s>0?(l.style.opacity="1",l.style.visibility="visible",I.strokeStyle="#22d3ee",I.lineWidth=2,I.setLineDash([5,5]),I.strokeRect(e,t,n,s),I.fillStyle="rgba(34, 211, 238, 0.1)",I.fillRect(e,t,n,s)):(l.style.opacity="0",l.style.visibility="hidden")}function X(){u=null,I.clearRect(0,0,l.width,l.height),l.style.opacity="0",l.style.visibility="hidden",et.disabled=!0,gt.style.opacity="0.5",ut.textContent="–",yt.textContent="–",ft.textContent="–",pt.textContent="–",vt.textContent="–"}function It(e){if(!L||!tt)return;const t=L.data,n=tt.data,s=L.width,i=L.height,a=Math.max(0,Math.min(e.x,s)),r=Math.max(0,Math.min(e.y,i)),y=Math.max(0,Math.min(e.x+e.w,s)),v=Math.max(0,Math.min(e.y+e.h,i)),m=Math.max(1,y-a),g=Math.max(1,v-r);let f=0,d=0;for(let b=r;b<v;b++)for(let $=a;$<y;$++){const o=(b*s+$)*4,Y=t[o],V=t[o+1],q=t[o+2],G=n[o],K=n[o+1],J=n[o+2],C=Math.abs(Y-G),M=Math.abs(V-K),D=Math.abs(q-J),R=(C+M+D)/3;d+=R*R,(C>S||M>S||D>S)&&f++}const h=m*g,E=h?f/h*100:0,p=h?d/h:0,U=p===0?1/0:20*Math.log10(255)-10*Math.log10(p);ut.textContent=`${m} × ${g}`,yt.textContent=`${E.toFixed(2)}%`,ft.textContent=p.toFixed(2),pt.textContent=Number.isFinite(U)?U.toFixed(2):"∞",vt.textContent=`${f.toLocaleString()} px`,gt.style.opacity="1"}F.addEventListener("change",()=>{F.checked?(c.style.cursor="crosshair",c.style.pointerEvents="auto",l.style.pointerEvents="none",w.canvas.width>0&&w.canvas.height>0&&j()):(X(),c.style.cursor="default",c.style.pointerEvents="auto")});window.addEventListener("resize",()=>{F.checked&&j(),nt()});et.addEventListener("click",()=>{X()});c.addEventListener("mousedown",e=>{if(!F.checked||!L)return;A=!0;const t=xt(e);H=t,u={x:t.x,y:t.y,w:0,h:0}});c.addEventListener("mousemove",e=>{if(!A||!F.checked)return;const t=xt(e);u={x:Math.min(H.x,t.x),y:Math.min(H.y,t.y),w:Math.abs(t.x-H.x),h:Math.abs(t.y-H.y)},At(u.x,u.y,u.w,u.h)});c.addEventListener("mouseup",()=>{A&&(A=!1,u&&u.w>0&&u.h>0?(et.disabled=!1,It(u)):X())});c.addEventListener("mouseleave",()=>{A&&(A=!1)});
