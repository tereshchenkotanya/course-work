(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const d of s.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function a(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=a(n);fetch(n.href,s)}})();function Bt(e,t,a,i,n){const s=e.canvas.width,d=e.canvas.height,h=e.getImageData(0,0,s,d),u=t.getImageData(0,0,s,d),y=a.createImageData(s,d);a.canvas.width!==s&&(a.canvas.width=s),a.canvas.height!==d&&(a.canvas.height=d);const f=h.data,B=u.data,r=y.data;let x=0,F=0;for(let o=0;o<f.length;o+=4){const X=f[o],Y=f[o+1],q=f[o+2],G=B[o],K=B[o+1],J=B[o+2],E=Math.abs(X-G),C=Math.abs(Y-K),M=Math.abs(q-J),D=(E+C+M)/3;F+=D*D;const Q=E>n||C>n||M>n;switch(Q&&x++,i){case"highlight":Q?(r[o]=239,r[o+1]=68,r[o+2]=68,r[o+3]=255):(r[o]=Math.round(f[o]*.6),r[o+1]=Math.round(f[o+1]*.6),r[o+2]=Math.round(f[o+2]*.6),r[o+3]=255);break;case"heatmap":{const Z=Math.min(255,Math.max(0,Math.floor(D)));r[o]=Z,r[o+1]=Math.min(80,Math.floor(Z*.3)),r[o+2]=255-Z,r[o+3]=255;break}case"diffRGB":r[o]=E,r[o+1]=C,r[o+2]=M,r[o+3]=255;break}}a.putImageData(y,0,0);const p=s*d,W=p?x/p*100:0,I=p?F/p:0,A=I===0?1/0:20*Math.log10(255)-10*Math.log10(I);return{imageData:y,metrics:{width:s,height:d,diffPixelsCount:x,totalPixels:p,diffPixelsPct:W,mse:I,psnr:A}}}async function at(e){const t=URL.createObjectURL(e),a=new Image;return await new Promise((i,n)=>{a.onload=()=>i(),a.onerror=n,a.src=t}),URL.revokeObjectURL(t),a}function T(e,t,a,i){const n=a??t.naturalWidth,s=i??t.naturalHeight;e.canvas.width=n,e.canvas.height=s,e.clearRect(0,0,n,s),e.drawImage(t,0,0,n,s)}const lt=document.getElementById("fileA"),dt=document.getElementById("fileB"),It=document.getElementById("resizeToA"),H=document.getElementById("tolerance"),rt=document.getElementById("tolVal"),bt=document.getElementById("mode"),_=document.getElementById("btnCompare"),ht=document.getElementById("btnDownload"),Et=document.getElementById("canvasA"),Ct=document.getElementById("canvasB"),c=document.getElementById("canvasDiff"),N=Et.getContext("2d"),O=Ct.getContext("2d"),g=c.getContext("2d"),it=document.getElementById("overlay"),ot=document.getElementById("imgA"),$=document.getElementById("imgB"),st=document.getElementById("slider"),k=document.getElementById("btnBlink"),Mt=document.getElementById("mDims"),Dt=document.getElementById("mPct"),Rt=document.getElementById("mMSE"),Lt=document.getElementById("mPSNR"),St=document.getElementById("mDiffCount"),z=document.getElementById("enableRegionSelect"),et=document.getElementById("btnClearRegion"),l=document.getElementById("canvasSelection"),v=l.getContext("2d"),mt=document.getElementById("regionMetrics"),gt=document.getElementById("rmDims"),ut=document.getElementById("rmPct"),yt=document.getElementById("rmMSE"),ft=document.getElementById("rmPSNR"),pt=document.getElementById("rmDiffCount");let w=null,b=null,U=null,m=null,S=!1,P={x:0,y:0},R=null,tt=null,L=16,ct="highlight";rt.textContent=H.value;H.addEventListener("input",()=>{rt.textContent=H.value,L=parseInt(H.value,10),m&&m.w>0&&m.h>0&&wt(m)});async function vt(){var a,i;const e=(a=lt.files)==null?void 0:a[0],t=(i=dt.files)==null?void 0:i[0];if(!e||!t){_.disabled=!0,k.disabled=!0,it.setAttribute("data-state","empty"),ot.removeAttribute("src"),$.removeAttribute("src");return}try{w=await at(e),b=await at(t),T(N,w),T(O,b),nt(),ot.src=URL.createObjectURL(e),$.src=URL.createObjectURL(t),it.setAttribute("data-state","ready"),_.disabled=!1,k.disabled=!1}catch(n){alert("Помилка завантаження зображення: "+n)}}lt.addEventListener("change",vt);dt.addEventListener("change",vt);_.addEventListener("click",async()=>{if(!w||!b)return;const e=w.naturalWidth===b.naturalWidth&&w.naturalHeight===b.naturalHeight;let t=w.naturalWidth,a=w.naturalHeight,i=b;if(!e)if(It.checked){const h=document.createElement("canvas");h.width=t,h.height=a,h.getContext("2d").drawImage(b,0,0,t,a);const y=new Image;y.src=h.toDataURL(),await y.decode(),i=y}else{alert("Різні розміри. Увімкніть підгонку B під A або підготуйте однакові зображення.");return}T(N,w,t,a),T(O,i,t,a),setTimeout(()=>{nt(),j()},100),g.canvas.width=t,g.canvas.height=a,l.width=t,l.height=a,c.style.display="block",c.style.width="100%",c.style.maxHeight="480px",c.style.position="relative",c.style.zIndex="1",c.style.pointerEvents="auto",l.style.background="transparent",l.style.pointerEvents="none",l.style.zIndex="2",l.style.opacity="0",l.style.visibility="hidden",v.clearRect(0,0,l.width,l.height),j(),L=parseInt(H.value,10),ct=bt.value;const n=Bt(N,O,g,ct,L),d=g.getImageData(0,0,Math.min(10,t),Math.min(10,a)).data.some((h,u)=>u%4!==3&&h!==0);console.log("Canvas diff check:",{internal:{width:g.canvas.width,height:g.canvas.height},display:{width:c.style.width,height:c.style.height},computed:{width:window.getComputedStyle(c).width,height:window.getComputedStyle(c).height},hasData:d,zIndex:window.getComputedStyle(c).zIndex}),(g.canvas.width===0||g.canvas.height===0)&&console.error("Canvas dimensions are zero!",{W:t,H:a,canvasWidth:g.canvas.width,canvasHeight:g.canvas.height}),c.style.visibility="visible",c.style.opacity="1",R=N.getImageData(0,0,t,a),tt=O.getImageData(0,0,t,a),Mt.textContent=`${n.metrics.width} × ${n.metrics.height}`,Dt.textContent=`${n.metrics.diffPixelsPct.toFixed(2)}%`,Rt.textContent=n.metrics.mse.toFixed(2),Lt.textContent=Number.isFinite(n.metrics.psnr)?n.metrics.psnr.toFixed(2):"∞",St.textContent=`${n.metrics.diffPixelsCount.toLocaleString()} px`,ht.disabled=!1,V()});ht.addEventListener("click",()=>{const e=c.toDataURL("image/png"),t=document.createElement("a");t.href=e,t.download="diff.png",t.click()});st.addEventListener("input",()=>{const e=parseInt(st.value,10);$.style.clipPath=`inset(0 ${100-e}% 0 0)`});k.addEventListener("click",()=>{if(U!==null){window.clearInterval(U),U=null,k.textContent="Миготіти A/B",$.style.opacity="1";return}k.textContent="Зупинити миготіння";let e=!0;U=window.setInterval(()=>{e=!e,$.style.opacity=e?"1":"0"},500)});function nt(){const e=document.getElementById("canvasA"),t=document.getElementById("canvasB"),a=document.getElementById("overlay"),i=document.getElementById("canvasDiff");if(e&&e.height>0){const n=e.getBoundingClientRect().height,s=window.getComputedStyle(e);if(t&&t.height>0){const d=t.width/t.height,h=n,u=h*d;t.style.height=`${h}px`,t.style.width=`${u}px`,t.style.maxHeight=s.maxHeight||"480px"}if(a&&(a.style.height=`${n}px`,a.style.maxHeight=s.maxHeight||"480px"),i&&i.height>0){const d=i.width/i.height,h=n,u=h*d;i.style.height=`${h}px`,i.style.width=`${u}px`,i.style.maxHeight=s.maxHeight||"480px"}}}function j(){c.getBoundingClientRect();const e=c.parentElement;e.getBoundingClientRect();const t=window.getComputedStyle(e),a=parseInt(t.paddingTop)||12,i=parseInt(t.paddingLeft)||12,n=window.getComputedStyle(c);l.style.width=n.width,l.style.height=n.height,l.style.maxHeight=n.maxHeight||"480px",l.style.top=`${a}px`,l.style.left=`${i}px`}function xt(e){const t=c.getBoundingClientRect(),a=c.width/t.width,i=c.height/t.height;return{x:Math.round((e.clientX-t.left)*a),y:Math.round((e.clientY-t.top)*i)}}function At(e,t,a,i){v.clearRect(0,0,l.width,l.height),a>0&&i>0?(l.style.opacity="1",l.style.visibility="visible",v.strokeStyle="#22d3ee",v.lineWidth=2,v.setLineDash([5,5]),v.strokeRect(e,t,a,i),v.fillStyle="rgba(34, 211, 238, 0.1)",v.fillRect(e,t,a,i)):(l.style.opacity="0",l.style.visibility="hidden")}function V(){m=null,v.clearRect(0,0,l.width,l.height),l.style.opacity="0",l.style.visibility="hidden",et.disabled=!0,mt.style.opacity="0.5",gt.textContent="–",ut.textContent="–",yt.textContent="–",ft.textContent="–",pt.textContent="–"}function wt(e){if(!R||!tt)return;const t=R.data,a=tt.data,i=R.width,n=R.height,s=Math.max(0,Math.min(e.x,i)),d=Math.max(0,Math.min(e.y,n)),h=Math.max(0,Math.min(e.x+e.w,i)),u=Math.max(0,Math.min(e.y+e.h,n)),y=Math.max(1,h-s),f=Math.max(1,u-d);let B=0,r=0;for(let I=d;I<u;I++)for(let A=s;A<h;A++){const o=(I*i+A)*4,X=t[o],Y=t[o+1],q=t[o+2],G=a[o],K=a[o+1],J=a[o+2],E=Math.abs(X-G),C=Math.abs(Y-K),M=Math.abs(q-J),D=(E+C+M)/3;r+=D*D,(E>L||C>L||M>L)&&B++}const x=y*f,F=x?B/x*100:0,p=x?r/x:0,W=p===0?1/0:20*Math.log10(255)-10*Math.log10(p);gt.textContent=`${y} × ${f}`,ut.textContent=`${F.toFixed(2)}%`,yt.textContent=p.toFixed(2),ft.textContent=Number.isFinite(W)?W.toFixed(2):"∞",pt.textContent=`${B.toLocaleString()} px`,mt.style.opacity="1"}z.addEventListener("change",()=>{z.checked?(c.style.cursor="crosshair",c.style.pointerEvents="auto",l.style.pointerEvents="none",g.canvas.width>0&&g.canvas.height>0&&j()):(V(),c.style.cursor="default",c.style.pointerEvents="auto")});window.addEventListener("resize",()=>{z.checked&&j(),nt()});et.addEventListener("click",()=>{V()});c.addEventListener("mousedown",e=>{if(!z.checked||!R)return;S=!0;const t=xt(e);P=t,m={x:t.x,y:t.y,w:0,h:0}});c.addEventListener("mousemove",e=>{if(!S||!z.checked)return;const t=xt(e);m={x:Math.min(P.x,t.x),y:Math.min(P.y,t.y),w:Math.abs(t.x-P.x),h:Math.abs(t.y-P.y)},At(m.x,m.y,m.w,m.h)});c.addEventListener("mouseup",()=>{S&&(S=!1,m&&m.w>0&&m.h>0?(et.disabled=!1,wt(m)):V())});c.addEventListener("mouseleave",()=>{S&&(S=!1)});
